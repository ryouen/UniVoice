### **仕様書: ヘッダーコントロールボタンのリファクタリング**

**バージョン:** 1.0
**作成日:** 2025年9月15日
**作成者:** Gemini

#### 1. 背景

現在の`UniVoice`アプリケーションのメインヘッダーには、UIの表示状態を制御するためのボタンが複数存在する。具体的には、「設定を開く(⚙️)」「メニューを隠す(🔽)」「設定バーの中からヘッダーを隠す」といった機能が異なるボタンに分散しており、ユーザーにとって直感的な操作が難しい状態にある。また、ボタン数が多く、UIが煩雑になっている。

このリファクタリングは、これらの問題を解決し、より洗練されたユーザー体験を提供することを目的とする。

#### 2. 目的

*   ヘッダー右側のコントロールボタンを削減し、UIをシンプルにする。
*   UIの状態（コンテキスト）に応じてボタンの機能が変化する直感的な操作モデルを導入する。
*   ボタンの役割をツールチップで動的に明示し、ユーザビリティを向上させる。

#### 3. 変更概要

*   **Before:** ヘッダー右側に`[設定(⚙️)]` `[最前面(📌)]` `[隠す(🔽)]` `[閉じる(✕)]`が並び、さらに設定バー内に`[ヘッダー非表示]`ボタンが存在する。
*   **After:** ヘッダー右側を`[最前面(📌)]` `[展開(▼)]` `[折りたたみ(▲)]` `[閉じる(✕)]`に再構成する。設定バー内のボタンは削除する。

#### 4. 詳細仕様

**4.1. 対象ファイル**
*   `src/components/UniVoice.tsx`

**4.2. 変更後のボタンレイアウト**

ヘッダー右側のボタン群の最終的なレイアウトは、以下の順序とする。各ボタンが占めるスロットのサイズ、間隔などの視覚的レイアウトは、変更前の状態を完全に維持すること。

```
[最前面ボタン(📌)] [展開ボタン(▼)] [折りたたみボタン(▲)] [スペース(20px)] [閉じるボタン(✕)]
```

**4.3. ボタンの動作定義**

新設する「展開(▼)」と「折りたたみ(▲)」ボタンは、アプリケーションの現在の状態に応じて、以下の通りに動作する。

| 現在の状態 | 操作対象ボタン | 実行されるアクション | 結果の状態 |
| :--- | :--- | :--- | :--- |
| **1. 標準** (ヘッダー:Full, 設定バー:Off) | **展開(▼)** | 設定バーを開く | **2. 設定バー表示** |
| **1. 標準** (ヘッダー:Full, 設定バー:Off) | **折りたたみ(▲)** | ヘッダーを最小化する | **3. コンパクト表示** |
| **2. 設定バー表示** (ヘッダー:Full, 設定バー:On) | **展開(▼)** | **（非表示）** | - |
| **2. 設定バー表示** (ヘッダー:Full, 設定バー:On) | **折りたたみ(▲)** | 設定バーを閉じる | **1. 標準** |
| **3. コンパクト表示** (ヘッダー:Compact) | **展開(▼)** | ヘッダーを復元する | **1. 標準** |
| **3. コンパクト表示** (ヘッダー:Compact) | **折りたたみ(▲)** | （表示されている場合）何もしない | - |

**4.4. ツールチップの動的変更**

ユーザビリティ向上のため、上記の状態に応じて各ボタンのツールチップを動的に変更する。

| ボタン | 状態 | ツールチップ表示テキスト |
| :--- | :--- | :--- |
| **展開(▼)** | ヘッダーがコンパクト表示中 | `ヘッダーを展開` |
| **展開(▼)** | ヘッダーがフル表示中 | `設定バーを開く` |
| **折りたたみ(▲)** | 設定バーが表示中 | `設定バーを閉じる` |
| **折りたたみ(▲)** | 設定バーが非表示中 | `ヘッダーを最小化` |

**4.5. 削除されるUI要素**

以下のUI要素は、今回のリファクタリングで完全に削除する。

1.  ヘッダー内の**「設定ボタン(⚙️)」**
2.  設定バー(`settingsBar`)内の**「ヘッダー表示/非表示ボタン」**

**4.6. 実装のヒント**

*   **制御ロジック:** 以下の2つのハンドラ関数を`UniVoice.tsx`内に作成し、ボタンの`onClick`イベントに接続することを推奨する。
    ```typescript
    // ▲ボタンのコンテキスト依存動作
    const handleCollapseClick = () => {
      if (showSettings) { // 設定バーが表示中か？
        setShowSettings(false); // trueなら設定バーを閉じる
      } else {
        setShowHeader(false); // falseならヘッダーを最小化
      }
    };

    // ▼ボタンのコンテキスト依存動作
    const handleExpandClick = () => {
      if (!showHeader) { // ヘッダーが最小化されているか？
        setShowHeader(true); // trueならフルヘッダーに戻す
      } else {
        setShowSettings(true); // falseなら設定バーを開く
      }
    };
    ```
*   **ツールチップ:** `React.useMemo`フックを使い、`showHeader`と`showSettings`の状態を監視してツールチップのテキストを生成する`tooltips`オブジェクトを作成すると効率的である。
*   **SVGアイコン:**
    *   **展開(▼)アイコン:** 既存の「メニューを隠すボタン」のSVGを流用する。
        `<path d="M6 7 L9 10 L12 7" strokeLinecap="round"/>`
    *   **折りたたみ(▲)アイコン:** 上記パスのY座標を反転させることで作成する。
        `<path d="M6 10 L9 7 L12 10" strokeLinecap="round"/>`

#### 5. 警告：プロジェクトの現状について

**最重要:** この仕様書を読む開発者への警告。

現在、このプロジェクトのテストスイートは**破損しており**、`npm run test`を実行すると多数（40件以上）のテストが失敗する。これは、UIコンポーネントのテストだけでなく、IPC通信やバックエンドサービスなど、広範囲に及んでいる。

したがって、**この仕様書に基づく実装が完了したとしても、自動テストによってその正当性を保証することはできない。**

実装者は、以下のいずれかの対応を必須とする。
a. **最優先でテストスイート全体の修復作業を行う。**
b. テストが失敗することを前提とし、あらゆる状態の組み合わせを考慮した、**徹底的な手動テスト**で品質を保証する。

---
