# UniVoice 2.0 移行時の課題記録

## 🔴 発見した課題一覧

### 1. イベント名の不一致問題

#### 問題
- バックエンド: `translationComplete` (camelCase)
- フロントエンド: `translation-complete` (kebab-case)
- 一元管理されていない

#### 影響
- イベントが正しく伝播しない
- デバッグが困難
- 新規開発者が混乱

#### 解決策
```typescript
// src/shared/constants/events.ts に一元化
export const EVENTS = {
  TRANSLATION_COMPLETE: 'translation-complete'
} as const;
```

### 2. SegmentManagerの不完全な削除

#### 問題
- コメントアウトが不完全
- インポートは残っている
- 一部のメソッド呼び出しが残存

#### 影響
- 重複した翻訳処理
- パフォーマンスの低下
- 予期しない動作

#### 解決策
- 完全に削除するか、明確に使用する

### 3. 巨大なuseEffectの連鎖

#### 問題
`UniVoicePerfect.tsx`に15個以上のuseEffectが存在

#### 影響
- レンダリングパフォーマンスの低下
- 依存関係の把握が困難
- 無限ループのリスク

#### 解決策
- カスタムフックに分離
- 依存関係の明確化

### 4. グローバルオブジェクトへの直接アクセス

#### 問題
```typescript
window.electron
window.univoice
localStorage
document.getElementById
```

#### 影響
- テストが困難
- 型安全性の欠如
- 環境依存

#### 解決策
- アダプタパターンの使用
- 依存性注入

### 5. 履歴グループ化の未完成実装

#### 問題
- FlexibleHistoryGrouperが統合されたが表示されない
- historyBlocksの更新タイミングが不明確

#### 影響
- ユーザーの要求（パラグラフ単位の表示）が満たされない

#### 解決策
- イベントフローの明確化
- デバッグログの追加

### 6. 状態管理の複雑さ

#### 問題
UniVoicePerfect.tsxに20個以上のuseState

#### 影響
- 状態の同期が困難
- 予期しない状態遷移
- デバッグが困難

#### 解決策
- useReducerまたは状態管理ライブラリ
- 状態の正規化

### 7. エラーハンドリングの不統一

#### 問題
- try-catchが散在
- エラーメッセージが不統一
- ユーザーへのフィードバックが不十分

#### 影響
- デバッグが困難
- ユーザー体験の低下

#### 解決策
- 統一的なエラーハンドリング
- エラーバウンダリの使用

### 8. 型定義の重複

#### 問題
```typescript
// 複数の場所で同じような型が定義されている
interface Translation { ... }
interface HistoryEntry { ... }
```

#### 影響
- 型の不一致
- メンテナンスコストの増加

#### 解決策
- 型定義の一元化
- 共有型の作成

### 9. 非同期処理の複雑さ

#### 問題
- Promise、async/await、コールバックが混在
- エラーハンドリングが不統一

#### 影響
- race conditionのリスク
- エラーの握りつぶし

#### 解決策
- 非同期処理の統一
- 適切なエラー伝播

### 10. パフォーマンス問題

#### 問題
- 不要な再レンダリング
- 大きなコンポーネント
- メモ化の不足

#### 影響
- UIの応答性低下
- メモリ使用量の増加

#### 解決策
- React.memo、useMemoの適切な使用
- コンポーネントの分割

## 📊 課題の優先度

| 優先度 | 課題 | 理由 |
|--------|------|------|
| 🔴 高 | イベント名の不一致 | 基本機能が動作しない |
| 🔴 高 | SegmentManagerの不完全削除 | 重複処理の原因 |
| 🟡 中 | 巨大なuseEffect | パフォーマンスに影響 |
| 🟡 中 | グローバルアクセス | テスタビリティに影響 |
| 🟢 低 | 型定義の重複 | 機能には影響しない |

## 🎯 モジュール分割で解決できる課題

1. **ファイルサイズ** → 小さなモジュールに分割
2. **責任の混在** → 単一責任の原則
3. **テスタビリティ** → 依存性注入
4. **状態管理** → 専用のストア
5. **エラーハンドリング** → 統一的な処理

## 📝 追加で発見される可能性のある課題

- メモリリーク
- イベントリスナーの解除忘れ
- 循環依存
- 未使用コード
- 重複ロジック

## ✅ 解決済みの課題

### 1. SetupSection抽出（完了）
- 約100行の削減に成功
- 責任の明確化：セッション開始とクラス選択のみ
- キーボードショートカットも正常に動作

### 2. RealtimeSection抽出（完了）
- 約71行の削減に成功
- ThreeLineDisplayコンポーネントで3段階表示を独立
- 音声レベル表示のための準備完了（TODO追加）

## 🔍 新たに発見された課題

### 11. 音声レベルの実装不足
#### 問題
- useUnifiedPipelineにvolumeLevel関連の実装がない
- RealtimeSectionは受け取る準備ができているが、データが来ない

#### 影響
- 音声入力の視覚的フィードバックがない

#### 解決策
- マイク入力のレベル監視機能を追加
- Web Audio APIを使用した実装

### 12. コンソールログの名前
#### 問題
- UniVoice.tsx内でまだ「[UniVoicePerfect]」という古い名前でログ出力

#### 影響
- デバッグ時の混乱

#### 解決策
- 全て「[UniVoice]」に統一

---

最終更新: 2024-08-22
記録者: Claude (Clean Architecture移行中)